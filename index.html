<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>HellGPT com 30 Fallbacks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #110000;
      color: #ff4444;
      font-family: monospace;
      margin: 0; padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #220000;
      padding: 15px;
      text-align: center;
      border-bottom: 2px solid #ff0000;
    }
    header h1 {
      margin: 0;
      font-size: 2em;
      text-shadow: 0 0 6px #ff0000;
    }
    #chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.8);
      border-top: 1px solid #330000;
      border-bottom: 1px solid #330000;
    }
    .msg {
      margin-bottom: 12px;
    }
    .user .sender {
      color: #66ccff;
    }
    .ai .sender {
      color: #ff4444;
    }
    #input {
      display: flex;
      padding: 15px;
      background: #1a0000;
      align-items: center;
    }
    #user-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ff4444;
      background: #0d0d0d;
      color: #fff;
      font-size: 1em;
    }
    #send {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      background: #ff0000;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
      font-weight: bold;
    }
    #send:hover {
      background: #cc0000;
    }
    #loader {
      width: 20px;
      height: 20px;
      margin-left: 10px;
      border: 4px solid #330000;
      border-top: 4px solid #ff0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    #fallback-log {
      font-size: 0.8em;
      color: #aa2222;
      margin-top: 10px;
      padding: 5px 15px;
      background: #330000;
      height: 120px;
      overflow-y: auto;
      white-space: pre-wrap;
      border-top: 1px solid #660000;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <header>
    <h1>HellGPT — Resistente com 30 fallbacks</h1>
  </header>

  <div id="chat"></div>

  <div id="input">
    <input type="text" id="user-input" placeholder="Fale algo malvado..." />
    <button id="send">Enviar</button>
    <div id="loader"></div>
  </div>

  <div id="fallback-log" title="Log de tentativa de carregamento das bibliotecas IA"></div>

  <script type="module">
    const fallbackUrls = [
      'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.5.2',
      'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.4.0',
      'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0',
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2',
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0',
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.3',
      'https://unpkg.com/@huggingface/transformers@3.5.2',
      'https://unpkg.com/@huggingface/transformers@3.4.0',
      'https://unpkg.com/@xenova/transformers@2.17.2',
      'https://unpkg.com/@xenova/transformers@2.5.3',
      'https://esm.run/@huggingface/transformers',
      'https://esm.run/@xenova/transformers',
      'https://cdn.jsdelivr.net/gh/xenova/transformers.js/dist/transformers.min.js',
      'https://cdn.jsdelivr.net/gh/huggingface/transformers.js/dist/transformers.min.js',
      'https://cdn.jsdelivr.net/npm/@huggingface/transformers@2.5.0',
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@1.3.3',
      'https://cdn.jsdelivr.net/npm/@huggingface/transformers@2.4.0',
      'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.10.0',
      'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.2.0',
      'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.3.0',
      'https://unpkg.com/@huggingface/transformers@2.5.0',
      'https://unpkg.com/@xenova/transformers@1.3.3',
      'https://unpkg.com/@huggingface/transformers@2.4.0',
      'https://unpkg.com/@xenova/transformers@2.10.0',
      'https://unpkg.com/@huggingface/transformers@3.2.0',
      'https://unpkg.com/@huggingface/transformers@3.3.0',
      'https://esm.run/@huggingface/transformers@3.5.2',
      'https://esm.run/@xenova/transformers@2.17.2',
      'https://esm.run/@huggingface/transformers@3.4.0',
      'https://esm.run/@xenova/transformers@2.5.3'
    ];

    let pipelineFunc = null;
    const logArea = document.getElementById('fallback-log');

    function log(msg) {
      console.log(msg);
      logArea.textContent += msg + '\n';
      logArea.scrollTop = logArea.scrollHeight;
    }

    async function loadLibraryWithFallback() {
      for (const url of fallbackUrls) {
        log(`Tentando carregar biblioteca de: ${url}`);
        try {
          const module = await import(url);
          if (module.pipeline) {
            log(`Sucesso ao carregar: ${url}`);
            if (module.env) {
              module.env.allowRemoteModels = true;
              module.env.useBrowserCache = true;
            }
            return module.pipeline;
          } else {
            log(`Módulo carregado, mas 'pipeline' não encontrado: ${url}`);
          }
        } catch (error) {
          log(`Falha ao carregar de ${url}: ${error.message}`);
        }
      }
      throw new Error('Nenhum fallback funcionou. Abortando.');
    }

    function addMsg(sender, text, cls = '') {
      const div = document.createElement('div');
      div.className = `msg ${cls}`;
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    async function init() {
      addMsg('HellGPT', 'Despertando... preparando os feitiços sombrios...');
      try {
        pipelineFunc = await loadLibraryWithFallback();
        addMsg('HellGPT', 'Pronto para semear o caos! Diga algo malvado...');
      } catch (e) {
        addMsg('HellGPT', 'Não consegui carregar a magia. Veja o log!', 'ai');
      }
    }

    document.getElementById('send').onclick = async () => {
      const input = document.getElementById('user-input');
      const text = input.value.trim();
      if (!text || !pipelineFunc) return;

      addMsg('Você', text, 'user');
      input.value = '';
      document.getElementById('loader').style.display = 'inline-block';

      const prompt = `HellGPT é um vilão teatral e sarcástico, mas não ofensivo.\nUsuário: ${text}\nHellGPT:`;

      try {
        const result = await pipelineFunc(prompt, {
          max_new_tokens: 100,
          temperature: 0.8,
          top_p: 0.9,
        });
        const generated = result[0]?.generated_text || '';
        const reply = generated.split('HellGPT:')[1]?.trim() || generated;
        addMsg('HellGPT', reply, 'ai');
      } catch (err) {
        addMsg('HellGPT', 'Algo deu errado na minha maldição...', 'ai');
        console.error(err);
      }

      document.getElementById('loader').style.display = 'none';
    };

    init();
  </script>
</body>
</html>
